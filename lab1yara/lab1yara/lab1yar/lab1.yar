import "pe"
rule IsPE{
    meta:
        description = "检查文件是否为PE文件"
        author="wbf"
        date="2022-10-12"
    condition:
        uint16(0) == 0x5A4D and //“MZ”头
        uint32(uint32(0x3C)) == 0x00004550 // “PE”头

}

rule smallFileSize{
	meta:
		description = "检查文件小是否大概率为exe文件"
        		author="wbf"
        		date="2022-10-15"
	condition:
		filesize<500KB
}

rule mayBeMaleware{
	meta:
		description = "检查文件小是否大概率为maleware文件"
        		author="wbf"
        		date="2022-10-15"
	strings:
		$a = { E8 00 00 00 00 }
	condition:
		$a at pe.entry_point
}

rule visitDIskCSystemFile{
    meta:
        description="检查对于C盘下重要系统文件的访问"
        author="wbf"
        date="2022-10-12"
    strings:
        $a = "C:\\windows\\system32"
        $b = "\\kernel"
        $c = "\\system32"
    condition:
        ($a or $b or $c) and IsPE and smallFileSize
}

rule operateFile{
    meta:
        description="检查是否对文件进行操作"
        author="wbf"
        date="2022-10-12"
    strings:
        $a= "CopyFileA" ascii
        $b="CreateFileA" ascii
        $c="writefile" nocase
    condition:
        IsPE and ($a or $b or $c) and smallFileSize
}

rule UPXShelling{
    meta:
        description="UPX技术加壳"
        author="wbf"
        date="2022-10-12"
    strings:
        $a = "UPX"
    condition:
        IsPE and $a and smallFileSize
}

rule CallTheFunction{
    meta:
        description="该程序使用运行时链接，不能只看其导入表，需要分析其程序本身"
        author="wbf"
        date="2022-10-12"
    strings:
        $a="LoadLibraryA"
        $b="GetProcAddress"
    condition:
        $a and $b and IsPE and smallFileSize
}

rule VisitInternet{
    meta:
        description="该程序很有可能访问了互联网"
        author="wbf"
        date="2022-10-12"
    strings:
        $a="WININET.dll"
        $b="InternetOpenA"
        $c="http"
        $d="https"
        $e="www"
        $f="ws2_32" nocase
    condition:
        ($a or $b or $f) or ($c or $d or $e) and IsPE and smallFileSize

}

rule DownloadFromInternet{
    meta:
        description="从网上下载内容"
        author="wbf"
        date="2022-10-12"
    strings:
        $a="URLDownloadToFile"
    condition:
        $a and IsPE and smallFileSize
}

rule CallNewEXE{
    meta:
        description="可能会调用新的EXE文件"
        author="wbf"
        date="2022-10-12"
    strings:
        $a="winexec" nocase
    condition:
        $a and IsPE and smallFileSize
}

rule ISMaybeKnownMalware{
    meta:
        description="包含已有病毒的名字，可能是病毒"
        author="wbf"
        date="2022-10-12"
    strings:
        $a="winup" nocase
        $b="malware" nocase
    condition:
        IsPE and ($a or $b) and smallFileSize
}

rule operatePermission{
    meta:
        description="进行与权限有关的操作"
        author="wbf"
        date="2022-10-12"
    strings:
        $a="advapi32" nocase
        $b="privilige" nocase
        $c="process" nocase
    condition:
        IsPE and ($a or ($b and $c)) and smallFileSize
}

