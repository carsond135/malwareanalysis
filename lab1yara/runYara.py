#!/usr/bin/env.python
# -*- coding: utf-8 -*-

import yara
import os
import sys
import time

# 获取目录内的yara规则文件
# 将yara规则编译
def getRules(path):
    filepath = {}
    for index, file in enumerate(os.listdir(path)):
        rupath = os.path.join(path, file)
        key = "rule" + str(index)
        filepath[key] = rupath
    yararule = yara.compile(filepaths=filepath)
    return yararule

# 扫描函数
def scan(rule, name):
    try:
        if(os.path.isfile(name)):
            fp=open(name,'rb')
            matches=rule.match(data=fp.read())
            if len(matches)>0:
                print(name,matches)
                return
            else:
                return
        else:
            for file_ls in os.listdir(name):
                scan(rule,os.path.join(name,file_ls))
    except (PermissionError, OSError):
        print("无法打开文件 " + name)


if __name__ == '__main__':
    time_start = time.time()
    rulepath = "D:\yara\yararules\lab1yara\lab1yar"   # yara规则目录
    malpath ="C:\\" # simple目录
    # yara规则编译函数调用
    yararule = getRules(rulepath)
    print("yara规则收集成功，正在扫描文件......")
    oldstdout = sys.stdout
    file = open(r'C:\Users\魏伯繁\Desktop\\test.txt', 'w', encoding='utf-8')
    sys.stdout = file
    # 扫描函数调用
    scan(yararule, malpath)
    file.close()
    sys.stdout=oldstdout;
    time_end = time.time()
    time_c = time_end - time_start  # 运行所花时间
    print('time cost', time_c, 's')

