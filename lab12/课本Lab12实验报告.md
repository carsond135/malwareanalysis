## 课本实验12实验报告

姓名：魏伯繁 学号：2011395 专业：信息安全

第一部分：Lab12-01

1、在你运行这个恶意代码可执行文件时，会发生什么

2、哪个进程会被注入

3、你如何能够让恶意代码停止弹出窗口？

4、这个恶意代码样本是如何工作的？

第一步：基本静态分析，在基本静态分析中，我们可以看到基于Lab12-01.exe的导入函数，我们看见了：CreateRemoteThread、WriteProcessMemory以及VirtualAllocEx，我们可以判定这可能是基于某种形式的进程注入恶意代码

![](G:\code\MalewareAnalysis\lab12\pic1\2.png)

当然，我们还可以看到一些其他的有意思的字符串，比如：explorer.exe、Lab12-01.dll以及psapi.dll

![](G:\code\MalewareAnalysis\lab12\pic1\10.png)

接下来，我们使用动态分析技术，当我们运行这个恶意代码时他每分钟都会弹出一个消息框，并且还会对弹出的次数进行计次，但是Procmon以及Process Explorer都没有什么明显的恶意进程以及恶意行为可以被观察到

![](G:\code\MalewareAnalysis\lab12\pic1\1.png)

![](G:\code\MalewareAnalysis\lab12\pic1\11.png)

然后，我们使用IDAPRO对恶意代码进行分析，在main函数刚开始的几行里可以看到这个代码正在解析psapi.dll中Windows枚举进程的函数，恶意代码使用了LoadLibrary和GetProcAddress来手动的解析3个函数：恶意代码保存指向408714/40870C以及408710的函数指针，他们分别代表了EnumProcessModules、GetModuleBaseNameA以及EnumProcesses，在动态解析结束后这段代码调用EnumProcess来获取在系统中每一个进程对象的PID。EnumProcesses返回一个由局部变量dwProcessId引用的PID数组，该引用将一个列表中的进程列表调用sub_401000

![](G:\code\MalewareAnalysis\lab12\pic1\12.png)

然后，我们来查看401000的代码，当动态解析的导入函数EnumProcessMoudles在PID被传给OpenProcess函数后被调用，然后我们就调用GetModuleBaseNameA，其中dword_40870C代表着GetModuleBaseNameA函数将PID翻译为进程名，然后我们将得到的字符串和explorer.exe进行比较赖在内存空间中找到explorer.exe

![](G:\code\MalewareAnalysis\lab12\pic1\13.png)

如果成功找到了该进程那么则返回1，main函数会调用OpenProcess来打开一个指向他的句柄，如果这个恶意代码成功改的返回了一个这个进程的句柄那么就执行下面的代码：调用一个VirtualAllocEx动态的explorer.exe中分配内存，上面提到的0x104字节通过压栈的方式当做参数传递，如果内存分配成功，一个指向被分配空间的lpBaseAddress会被移动到该句柄中。

![](G:\code\MalewareAnalysis\lab12\pic1\5.png)

该句柄和进程句柄hprocess会被当做参数一起传递给WriteProcessMemory以便向explorer.exe中传递数据，写入这个进程的数据存储在了lpBuffer中

![](G:\code\MalewareAnalysis\lab12\pic1\6.png)

如果上面的内容成功写入了则会进入下面代码的执行首先调用GetModuleHandleA以及GetProcAddress来获取LoadLibraryA的地址。在本恶意样本中LoadLibrary和explorer.exe的地址相同，于是使用指令

```assmble
mov [ebp+lpStartAddress]， eax
```

来讲LoadLibraryA的地址写入lpStarAddress中，CreateRemoteThread的参数lpStarAddress参数强制explorer.exe调用LoadLibraryA。他的参数通过CreateRemoteThread中的lpParameter传递，也即是包含Lab12-01的字符串，于是，在远程进程中启动一个线程，这个线程以参数Lab12-01.dll来调用LoadLibraryA。我们现在可以断定这个恶意代码进行了DLL注入，将Lab12-01.dll注入到explorer.exe中

![](G:\code\MalewareAnalysis\lab12\pic1\7.png)

当我们知道什么东西被注入了时就可以想办法去停止他，使用Process Explorer来进行停止恶意代码的运行，我们可以看到在explorer.exe中载入了Lab12-01.dll，在确定我们的分析无误后，我们可以使用Process Explorer来停止该进程的执行，然后再通过在Run中输入explorer重启进程

于是我们可以明确的是，恶意代码的功能都是由dll文件提供的，于是我们分析dll文件：我们可以看到其开启了一个新的线程，线程调用的函数的句柄为lpStartAddress，他用来创建消息框并显示Press OK to reboot，他用一个sprintf拼接的参数作为这个消息框的标题，这个参数用Format字符串来显示“Practical Malware Analysis”+其对话框弹出的次数，每次执行都都会睡眠60s然后再次执行

![](G:\code\MalewareAnalysis\lab12\pic1\9.png)